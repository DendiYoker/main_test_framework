name: CI - Run Tests with Allure Reports

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å: –ø—Ä–∏ –ª—é–±–æ–º push –∏–ª–∏ pull request –≤ master
on:
  push:
    branches: [ '**' ] # ** - –ª—é–±–∞—è –≤–µ—Ç–∫–∞ (feature/*, hotfix/*, test-* –∏ —Ç.–¥.)
  pull_request:
    branches: [ master ]  # –ø—Ä–∏ PR —Ç–æ–ª—å–∫–æ –≤ master

jobs:
  test:
    runs-on: ubuntu-latest  # GitHub –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É

    steps:
    # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    # 3. –ö–µ—à–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-python-${{ hashFiles('requirements.txt') }}

    # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    # 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Chrome (–±—Ä–∞—É–∑–µ—Ä –¥–ª—è Selenium)
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        echo "‚úÖ Chrome —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:"
        google-chrome --version

    # 6. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Allure
    - name: Run tests and collect Allure data
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Allure
        mkdir -p allure-results     
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Allure
        python -m pytest tests/ \
          -v \
          --alluredir=allure-results  # ‚Üê –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä

  # 7. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Allure CLI –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
    - name: Generate Allure report
      if: always()  # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Allure CLI (–≤–µ—Ä—Å–∏—è 2.29.0)
        ALLURE_VERSION=2.29.0  # –û–±–Ω–æ–≤–∏–ª –≤–µ—Ä—Å–∏—é –¥–æ 2.29.0
        curl -o allure-$ALLURE_VERSION.tgz -Ls https://github.com/allure-framework/allure2/releases/download/$ALLURE_VERSION/allure-$ALLURE_VERSION.tgz
        tar -zxvf allure-$ALLURE_VERSION.tgz -C /opt/
        sudo ln -s /opt/allure-$ALLURE_VERSION/bin/allure /usr/bin/allure
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –æ—Ç—á–µ—Ç
        allure generate allure-results -o allure-report --clean
        
        echo "üìä Allure –æ—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ allure-report/"
        
        echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ allure-report:"
        ls -la allure-report

    # 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å)
    - name: Upload Allure report as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-report
        path: allure-report/
        retention-days: 7

    # 9. –î–µ–ø–ª–æ–∏–º –æ—Ç—á–µ—Ç –Ω–∞ GitHub Pages (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - name: Deploy Allure report to GitHub Pages
      #  –µ—Å–ª–∏ push –∏–¥–µ—Ç –≤ –≤–µ—Ç–∫—É main –∏–ª–∏ –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ pull request
      # if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
      if: always()
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./allure-report
        keep_files: false

    # 10. –í—ã–≤–æ–¥–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç—á–µ—Ç
    - name: Display Allure report URL
      if: always()
      run: |
        echo ""
        echo "üöÄ CI/CD Pipeline Completed Successfully!"
        echo "================================================"
        echo ""
        echo "üìä ALLURE TEST REPORT"
        echo "   üåê View online: https://dendiyoker.github.io/main_test_framework/"
        echo "   üì• Download: Go to Actions ‚Üí Artifacts ‚Üí allure-report"
        echo ""
        echo "‚ö° QUICK LINKS"
        echo "   üîç View Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "   üìö Repository: https://github.com/${{ github.repository }}"
        echo ""
        echo "üîÑ Next Steps:"
        echo "   ‚Ä¢ Review the test results"
        echo "   ‚Ä¢ Check failed tests if any"
        echo "   ‚Ä¢ Update tests if needed"
        echo "================================================"
        echo ""