name: üöÄ Run Custom Tests with Parameters

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '–í–µ—Ç–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤'
        required: true
        default: 'master'
        type: string

      test_type:
        description: '–¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - story
          - feature
          - severity
          - pytest_mark
          - file_path

      story_name:
        description: '–ù–∞–∑–≤–∞–Ω–∏–µ .story (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç")'
        required: false
        type: string
        default: ''
        # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ test_type == 'story'
        if: inputs.test_type == 'story'

      feature_name:
        description: '–ù–∞–∑–≤–∞–Ω–∏–µ feature (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ë–∞–∑–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏")'
        required: false
        type: string
        default: ''
        if: inputs.test_type == 'feature'

      severity_level:
        description: '–£—Ä–æ–≤–µ–Ω—å –≤–∞–∂–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∞'
        required: false
        type: choice
        options:
          - blocker
          - critical
          - normal
          - minor
          - trivial
        default: 'normal'
        if: inputs.test_type == 'severity'

      pytest_marker:
        description: 'Pytest –º–∞—Ä–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: "smoke" –∏–ª–∏ "regression")'
        required: false
        type: string
        default: ''
        if: inputs.test_type == 'pytest_mark'

      test_path:
        description: '–ü—É—Ç—å –∫ —Ç–µ—Å—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: tests/login/test_auth.py)'
        required: false
        type: string
        default: 'tests/'
        if: inputs.test_type == 'file_path'

#      parallel_execution:
#        description: '–ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ?'
#        required: false
#        type: boolean
#        default: false

jobs:
  run-custom-tests:
    runs-on: ubuntu-latest

    steps:
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–µ—Ç–∫—É
    - name: Checkout ${{ inputs.branch }} branch
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}
        fetch-depth: 0

    # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python
    - name: Setup Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    # 3. –ö–µ—à–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-python-${{ inputs.branch }}-${{ hashFiles('pyproject.toml') }}

    # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install .[dev]

    # 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Chrome
    - name: Install Chrome for Selenium
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        echo "‚úÖ Chrome —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:"
        google-chrome --version

    # 6. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
    - name: Prepare test command
      id: test_command
      run: |
        # –ë–∞–∑–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
        CMD="pytest -v --alluredir=allure-results"
        
#        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
#        if ${{ inputs.parallel_execution }}; then
#          CMD="$CMD -n auto"
#        fi
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        case "${{ inputs.test_type }}" in
          "story")
            if [ -n "${{ inputs.story_name }}" ]; then
              CMD="$CMD --allure-stories='${{ inputs.story_name }}'"
            fi
            ;;
          "feature")
            if [ -n "${{ inputs.feature_name }}" ]; then
              CMD="$CMD --allure-features='${{ inputs.feature_name }}'"
            fi
            ;;
          "severity")
            CMD="$CMD --allure-severities='${{ inputs.severity_level }}'"
            ;;
          "pytest_mark")
            if [ -n "${{ inputs.pytest_marker }}" ]; then
              CMD="$CMD -m '${{ inputs.pytest_marker }}'"
            fi
            ;;
          "file_path")
            CMD="$CMD '${{ inputs.test_path }}'"
            ;;
          "all")
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
            CMD="$CMD tests/"
            ;;
        esac
        
        # –í—ã–≤–æ–¥–∏–º –∫–æ–º–∞–Ω–¥—É
        echo "üîß –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: $CMD"
        echo "command=$CMD" >> $GITHUB_OUTPUT

    # 7. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    - name: Run selected tests
      run: |
        mkdir -p allure-results
        echo "üéØ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏–∑ –≤–µ—Ç–∫–∏: ${{ inputs.branch }}"
        echo "üìä –¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${{ inputs.test_type }}"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if [[ "${{ inputs.test_type }}" == "story" && -n "${{ inputs.story_name }}" ]]; then
          echo "üìñ Story: ${{ inputs.story_name }}"
        fi
        
        if [[ "${{ inputs.test_type }}" == "feature" && -n "${{ inputs.feature_name }}" ]]; then
          echo "üè∑Ô∏è Feature: ${{ inputs.feature_name }}"
        fi
        
        if [[ "${{ inputs.test_type }}" == "severity" ]]; then
          echo "‚ö†Ô∏è Severity: ${{ inputs.severity_level }}"
        fi
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
        ${{ steps.test_command.outputs.command }}

    # 8. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç Allure
    - name: Generate Allure report
      if: always()
      run: |
        ALLURE_VERSION=2.29.0
        curl -o allure-$ALLURE_VERSION.tgz -Ls https://github.com/allure-framework/allure2/releases/download/$ALLURE_VERSION/allure-$ALLURE_VERSION.tgz
        tar -zxvf allure-$ALLURE_VERSION.tgz -C /opt/
        sudo ln -s /opt/allure-$ALLURE_VERSION/bin/allure /usr/bin/allure
        
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –æ—Ç—á–µ—Ç–∞
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BRANCH_SLUG=$(echo "${{ inputs.branch }}" | sed 's/[^a-zA-Z0-9]/_/g')
        REPORT_NAME="allure-report-${BRANCH_SLUG}-${TIMESTAMP}"
        
        allure generate allure-results -o $REPORT_NAME --clean
        echo "üìä Allure –æ—Ç—á–µ—Ç: $REPORT_NAME"
        echo "report_name=$REPORT_NAME" >> $GITHUB_OUTPUT

    # 9. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - name: Upload Allure report as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-report-${{ github.run_id }}
        path: ${{ steps.generate_report.outputs.report_name }}
        retention-days: 14

    # 10. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–µ–ø–ª–æ–π –Ω–∞ GitHub Pages –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É
    - name: Deploy to GitHub Pages (separate folder)
      if: always()
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./${{ steps.generate_report.outputs.report_name }}
        destination_dir: ./manual-runs/${{ github.run_id }}
        keep_files: false

    # 11. –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    - name: Display results summary
      if: always()
      run: |
        echo ""
        echo "================================================"
        echo "üöÄ –†–£–ß–ù–û–ô –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –ó–ê–í–ï–†–®–ï–ù"
        echo "================================================"
        echo ""
        echo "üìã –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–£–°–ö–ê:"
        echo "   üåø –í–µ—Ç–∫–∞: ${{ inputs.branch }}"
        echo "   üéØ –¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${{ inputs.test_type }}"
        
        if [[ "${{ inputs.test_type }}" == "story" && -n "${{ inputs.story_name }}" ]]; then
          echo "   üìñ Story: ${{ inputs.story_name }}"
        fi
        
        if [[ "${{ inputs.test_type }}" == "feature" && -n "${{ inputs.feature_name }}" ]]; then
          echo "   üè∑Ô∏è Feature: ${{ inputs.feature_name }}"
        fi
        
        echo ""
        echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
        echo "   üìÅ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç: allure-report-${{ github.run_id }}"
        echo "   üåê –û–Ω–ª–∞–π–Ω –æ—Ç—á–µ—Ç: https://dendiyoker.github.io/main_test_framework/manual-runs/${{ github.run_id }}/"
        echo ""
        echo "üîó –°–°–´–õ–ö–ò:"
        echo "   üìà –î–µ—Ç–∞–ª–∏ –∑–∞–ø—É—Å–∫–∞: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "   üì¶ –í—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
        echo ""
        echo "================================================"